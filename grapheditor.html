<html>
    <head>
        <meta charset="UTF-8">
        <title>Main</title>
        <script src="elm.js"></script>
    </head>

    <body>
        <h1>Graph editor</h1>
        <p>
            A graph editor, with labelled nodes and edges.
        The code is available on
        <a href="https://github.com/amblafont/graph-editor-web">github</a>.
        </p>
        <button onclick="loadGraph()" >Load graph</button>
        <div id="myapp"></div>
        <script>
         var appDiv = document.getElementById('myapp');
        var idFocus = "edited_label";
        var classLifecycle = "lifecycle";
         
        function dispatchCreate(node) {
            console.log("added node: " + node.tagName);
            if (node.getBoundingClientRect != null)
                     {
                         // could be optimized by having an additionnal
                         // attribute that tells whether it has
                         // a listener, so that we don't need
                         // to get the bounding rectangle
                         var rect = node.getBoundingClientRect();

                         node.dispatchEvent(new CustomEvent("create", { detail : rect } ));
                     }
        };

         // newsize event handlers
         // Fonction callback à éxécuter quand une mutation est observée
         var callbackMutation = function(mutationsList) {
             for(var mutation of mutationsList) {
	               for(var node of mutation.addedNodes) {
                     //console.log("added node: " + node.tagName);
                     //console.log(node.innerHTML);
                     /* console.log(node.id); */
                     dispatchCreate(node);
                     if (node.getElementsByClassName == null) {
                         console.log("no getElementsByClassName");
                         continue;
                     }

                     children = node.getElementsByClassName(classLifecycle);
                     for (var i = 0; i < children.length; ++i) {
                          dispatchCreate(children[i]);
                      }                 
                     // Y en a marre que ca focuse pas
                     // ca ne marche pas!!
                     /*if (node.id == "edited_label") {
                         console.log("coucou");
                         node.addEventListener("focus", function () { console.log("edited_label: focus"); });

                         node.focus();
                     }*/

                 }
                 // TODO utiliser slotchange on custom elements
	               for(var node of mutation.removedNodes) {
                     if (node.getBoundingClientRect != null)
                     {
                         node.dispatchEvent(new CustomEvent("remove"));
                     }
                 }
             }
         };

         // Créé une instance de l'observateur lié à la fonction de callback
         var observer = new MutationObserver(callbackMutation);
         observer.observe(appDiv, 
	                        { subtree: true, childList: true }); 

         // initialisation de Elm

         var app = Elm.GraphEditor.init({
             node: appDiv
         });
         // load a json graph file, send it to the elm component
         function loadGraph() {
             var input = document.createElement('input');
             input.type = 'file';
             input.accept = ".json";
             input.onchange = e => {
                 var file = e.target.files[0];
                 var fr=new FileReader();
                 fr.onload=function(){
                     var json = JSON.parse (fr.result);
                     app.ports.loadedGraph.send(json);
                 }
                 fr.readAsText(file);
             }

             input.click();
         };
         // this event handler computes the relative position
         // of the mouse with respect to the current target
         // (the one to which the event is attached)
         app.ports.onMouseMove.subscribe(function(e) {
             if ( e.currentTarget) {
                 var rect = e.currentTarget.getBoundingClientRect();
                 var x = e.clientX - rect.left; //x position within the element.
                 var y = e.clientY - rect.top;  //y position within the element.
                 app.ports.onMouseMoveFromJS.send([x, y]);
             }
         });
         // asks the user to download some file, generated from content
         function download(content, fileName, contentType) {
             var a = document.createElement("a");
             var file = new Blob([content], {type: contentType});
             a.href = URL.createObjectURL(file);
             a.download = fileName;
             a.click();
         }
         app.ports.saveGraph.subscribe(function(d) {
             download(JSON.stringify(d), 'graph.json', 'application/json');
         });
        </script>
    </body>
</html>
