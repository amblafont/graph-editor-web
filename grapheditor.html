<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Main</title>
        <script>
            const renderedClass = "rendered-callback";
            const renderedEvent = "rendered";
        </script>
        <script src="elm.js"></script>
        
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script src="js/katex.min.css.js"></script>
        <script src="js/katex-custom-element.js"></script>
    <script onLoad="initKatex()" 
             defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>

       

             <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">

        
        <!-- Make foreignobject in svg visible -->
         <style>
          foreignObject { overflow:visible;
          /* to allow clicking through the overflow */
            pointer-events: none
          } 
          foreignObject * { 
              pointer-events: all;
          }
          #canvas {
              width: 4000px;
              height: 4000px;
          }
         .active-label { 
             border-color: red;
             border-style: solid;
             border-width: 1px;
             /* the outline is nice because it does not
             affect the width and height. Unfortunately,
             it does not behave nicely with \int_x */
             /* outline-style: solid; outline-color: red; */
             }
             /* selection rectangle */
             .rect-select {
                stroke: black;
                stroke-width: 1px;
                stroke-dasharray: 2;
                fill:transparent;
             }     
            .help-div {
                height: 5em;
                overflow: scroll;
            }
            path:hover {
                stroke-width : 4;
            }        
        </style> 
        <script>
            document.addEventListener("keydown", function(event)
            {
                // Tab key
                if (event.keyCode === 9)
                    event.preventDefault();          
            }
            );
            // copied and pasted from tutorial.json
            var tutorial = [[{"id":0,"label":{"label":"","pos":[255,136.63333129882812]}},{"id":1,"label":{"label":"\\textbf{Basic tutorial}","pos":[85.5,16.133331298828125]}},{"id":2,"label":{"label":"\\text{Select the point below, press 'a' , and use 'hjkl' to move the target point}","pos":[525,109.63333129882812]}},{"id":3,"label":{"label":"\\text{\\underline{Arrow creation}}","pos":[82.5,103.63333129882812]}},{"id":7,"label":{"label":"\\text{\\underline{Commutative square}}","pos":[105,171.63333129882812]}},{"id":8,"label":{"label":"FS0","pos":[122,224.63333129882812]}},{"id":9,"label":{"label":"FSx","pos":[322,224.63333129882812]}},{"id":11,"label":{"label":"S(Fx+S0)","pos":[322,424.6333312988281]}},{"id":15,"label":{"label":"\\text{Select the node $FSx$ below,  then press 's'}","pos":[396,171.63333129882812]}},{"id":23,"label":{"label":"\\text{\\underline{Move \\& Merge}}","pos":[86.5,496.1333312988281]}},{"id":24,"label":{"label":"a","pos":[173.5,587.1333312988281]}},{"id":25,"label":{"label":"b","pos":[271.5,647.1333312988281]}},{"id":27,"label":{"label":"c","pos":[170.5,713.1333312988281]}},{"id":53,"label":{"label":"a'","pos":[465.5,587.1333312988281]}},{"id":54,"label":{"label":"b'","pos":[407.5,646.1333312988281]}},{"id":56,"label":{"label":"c'","pos":[462.5,713.1333312988281]}},{"id":73,"label":{"label":"\\text{Select the node $b$ below, press 'g' and use 'hjkl' to move. }","pos":[442.5,498.1333312988281]}},{"id":74,"label":{"label":"\\text{Hold 'ctrl' when hovering $b'$ to merge.}","pos":[366.5,528.1333312988281]}},{"id":75,"label":{"label":"h:FS \\rightarrow{S(F-+S0)}","pos":[524,314.6333312988281]}},{"id":76,"label":{"label":"\\text{Read the header help message for a complete list of available commands}","pos":[498.5,14.133331298828125]}},{"id":77,"label":{"label":"","pos":[162.5,828.6333312988281]}},{"id":79,"label":{"label":"\\text{Select the arrow below, press 'r'}","pos":[332,791.6333312988281]}},{"id":80,"label":{"label":"\\text{\\underline{Rename}}","pos":[61,792.6333312988281]}},{"id":81,"label":{"label":"","pos":[362.5,828.6333312988281]}},{"id":160,"label":{"label":"","pos":[167,1061.2583312988281]}},{"id":162,"label":{"label":"\\text{Select the arrow below, press 'a', then '='}","pos":[377,891.6333312988281]}},{"id":163,"label":{"label":"\\text{\\underline{Higher cells}}","pos":[74,888.6333312988281]}},{"id":164,"label":{"label":"","pos":[367,1061.2583312988281]}},{"id":166,"label":{"label":"","pos":[267,966.0083312988281]}},{"id":169,"label":{"label":"\\text{(depending on the current mode)}","pos":[335.5,37.133331298828125]}},{"id":172,"label":{"label":"\\text{Press 'p' and click somewhere}","pos":[352,75.63333129882812]}},{"id":173,"label":{"label":"\\text{\\underline{Point creation}}","pos":[78,73.63333129882812]}}],[{"from":8,"id":10,"label":{"bend":0,"label":"FSi","style":{"dashed":false,"double":false,"head":"default","tail":"none"}},"to":9},{"from":9,"id":12,"label":{"bend":0,"label":"hx","style":{"dashed":false,"double":false,"head":"default","tail":"none"}},"to":11},{"from":24,"id":26,"label":{"bend":0,"label":"","style":{"dashed":false,"double":false,"head":"default","tail":"none"}},"to":25},{"from":25,"id":28,"label":{"bend":0,"label":"","style":{"dashed":false,"double":false,"head":"default","tail":"none"}},"to":27},{"from":53,"id":55,"label":{"bend":0,"label":"","style":{"dashed":false,"double":false,"head":"default","tail":"none"}},"to":54},{"from":54,"id":57,"label":{"bend":0,"label":"","style":{"dashed":false,"double":false,"head":"default","tail":"none"}},"to":56},{"from":77,"id":82,"label":{"bend":0,"label":"\\text{rename me}","style":{"dashed":false,"double":false,"head":"default","tail":"none"}},"to":81},{"from":160,"id":165,"label":{"bend":0,"label":"\\text{select me}","style":{"dashed":false,"double":false,"head":"default","tail":"none"}},"to":164},{"from":160,"id":167,"label":{"bend":0,"label":"","style":{"dashed":false,"double":false,"head":"default","tail":"none"}},"to":166},{"from":164,"id":168,"label":{"bend":0,"label":"","style":{"dashed":false,"double":false,"head":"default","tail":"none"}},"to":166}]];
        </script>
    </head>

    <body>       
        <h1>Diagram editor</h1>
   
     
        <p>
            A vi-inspired diagram editor, with              
            (latex) labelled nodes and edges, tested with Firefox, written in <a href="https://elm-lang.org/">Elm</a>. 
            Higher cells are supported.
        The code is available on
        <a href="https://github.com/amblafont/graph-editor-web">github</a>.
        </p>
        <button onclick="loadGraph()" >Load graph</button>
    <!--     <button onclick="dispatchRenderedChildren(document)">
            Recompute the layer
        </button> -->
        
        <!-- first use of katex element. It seems it should be done
        beforehand, otherwise dispatchRendered on the first labelled point  
        gets wrong dimensions.
        -->
        <math-latex> </math-latex>
        <div id="myapp"></div>
        <script>
         var appDiv = document.getElementById('myapp');
        
        
         
        function dispatchRendered(node) {            
            if (node.clientWidth != null)
                     {
                         // could be optimized by having an additionnal
                         // attribute that tells whether it has
                         // a listener
                         var rect = { width : node.clientWidth , height : node.clientHeight }
                         /* if (node.tagName = "MATH-LATEX") {
                            console.log (rect);
                            console.log (node.getBoundingClientRect());
                         } */
                         node.dispatchEvent(new CustomEvent(renderedEvent, { detail : rect } ));
                     }
        };

        function dispatchRenderedChildren(node) {
            children = node.getElementsByClassName(renderedClass);
                     for (var i = 0; i < children.length; ++i) {
                          dispatchRendered(children[i]);
                      }        
        }

         // rendered event handlers
         // Fonction callback à éxécuter quand une mutation est observée
         var callbackMutation = function(mutationsList) {
             for(var mutation of mutationsList) {
	               for(var node of mutation.addedNodes) {
             
                     dispatchRendered(node);
                     if (node.getElementsByClassName != null) {                                                  
                         dispatchRenderedChildren(node);  
                     }
                 }
                
	            /*    for(var node of mutation.removedNodes) {
                     if (node.getBoundingClientRect != null)
                     {
                         node.dispatchEvent(new CustomEvent("remove"));
                     }
                 } */
             }
         };

         // Créé une instance de l'observateur lié à la fonction de callback
         var observer = new MutationObserver(callbackMutation);
         observer.observe(appDiv, 
	                        { subtree: true, childList: true }); 

         // initialisation de Elm

         var app = Elm.Main.init({
             node: appDiv
         });
         
         app.ports.loadedGraph.send(tutorial);
         
         // load a json graph file, send it to the elm component
         function loadGraph() {
             var input = document.createElement('input');
             input.type = 'file';
             input.accept = ".json";
             input.onchange = e => {
                 var file = e.target.files[0];
                 var fr=new FileReader();
                 fr.onload=function(){
                     var json = JSON.parse (fr.result);
                     app.ports.loadedGraph.send(json);
                 }
                 fr.readAsText(file);
             }

             input.click();
         };
         // this event handler computes the relative position
         // of the mouse with respect to the current target
         // (the one to which the event is attached)
         app.ports.onMouseMove.subscribe(function(e) {
             if ( e.currentTarget) {
                 var rect = e.currentTarget.getBoundingClientRect();
                 var x = e.clientX - rect.left; //x position within the element.
                 var y = e.clientY - rect.top;  //y position within the element.
                 app.ports.onMouseMoveFromJS.send([x, y]);
             }
         });

         app.ports.preventDefault.subscribe(function (e) {
             e.preventDefault();
         });
         // asks the user to download some file, generated from content
         function download(content, fileName, contentType) {
             var a = document.createElement("a");
             var file = new Blob([content], {type: contentType});
             a.href = URL.createObjectURL(file);
             a.download = fileName;
             a.click();
         }
         app.ports.saveGraph.subscribe(function(d) {
             download(JSON.stringify(d), 'graph.json', 'application/json');
         });

         document.addEventListener("keydown", function(event)
            {
                if    // slash key
                  (event.key === "/")
                    app.ports.onSlashKey.send(event);

            }
        );
        </script>
    </body>
</html>
