<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Main</title>
        <script>
            const renderedClass = "rendered-callback";
            const renderedEvent = "rendered";
        </script>
        <script src="elm.js"></script>
        
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script src="js/katex.min.css.js"></script>
        <script src="js/katex-custom-element.js"></script>
        <script>
        /*
         Clipboard data can't be accessed when adding a paste handler
         directly from elm because elm internals perform some timeout
         before calling the handler and firefox forbids access after timeout.
         More precisely, firefox forbids direct access to the clipboard data
         if not directly as a result of a user interaction.

         The following custom element is a workarwound: it dispatches
         clipboard data on paste.

         Note: Elm does not work well is inherited custom elements
         (https://github.com/elm/virtual-dom/issues/156). My first 
         failed attempt was to inherit a div.
         
         inspired by https://github.com/rupertlssmith/elm-input-spike/blob/main/assets/elm-editable.js#L105         
        */
         const pasteEvent = "pasteData"
         const pasteElement = "paste-capture"
         class PasteCaptureElement extends HTMLElement {
            constructor() {                
                super();
                this.pasteCallback = this.pasteCallback.bind(this);
            }

             connectedCallback() {                               
                this.addEventListener("paste", this.pasteCallback);              
            }
            
            disconnectedCallback() {
               this.removeEventListener("paste", this.pasteCallback);            
            }
            pasteCallback(e) { 
               // alert('cou');
                const clipboardData = e.clipboardData || window.clipboardData;
                const text = clipboardData.getData('text') || "";                      
                const newEvent = new CustomEvent(pasteEvent, {
                    detail: text });

                this.dispatchEvent(newEvent);                
            } 
         }


        customElements.define(pasteElement, PasteCaptureElement);
        </script>
    <script onLoad="initKatex()" 
             defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>

       

             <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">

        
        <!-- Make foreignobject in svg visible -->
         <style>
          foreignObject { overflow:visible;
          /* to allow clicking through the overflow */
            pointer-events: none
          } 
          foreignObject * { 
              pointer-events: all;
          }
          #canvas {
              width: 4000px;
              height: 4000px;
          }
         .active-label { 
             border-color: red;
             border-style: solid;
             border-width: 1px;
             /* the outline is nice because it does not
             affect the width and height. Unfortunately,
             it does not behave nicely with \int_x */
             /* outline-style: solid; outline-color: red; */
             }
             .weak-active-label { 
             border-color: blue;
             border-style: dashed;
             border-width: 2px;
             /* the outline is nice because it does not
             affect the width and height. Unfortunately,
             it does not behave nicely with \int_x */
             /* outline-style: solid; outline-color: red; */
             }
             /* selection rectangle */
             .rect-select {
                stroke: black;
                stroke-width: 1px;
                stroke-dasharray: 2;
                fill:transparent;
             }     
            .help-div {
                height: 5em;
                overflow: scroll;
            }
            path:hover {
                stroke-width : 4;
            }        
        </style> 
        <script>         
            // LocalStorage key used for quicksave
            const storageKey = "yadegraph";

            var tutorial = {"edges":[{"from":5,"id":53,"label":{"label":"FSi","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":6},{"from":6,"id":54,"label":{"label":"hx","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":7},{"from":12,"id":55,"label":{"label":"","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":13},{"from":13,"id":56,"label":{"label":"","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":14},{"from":19,"id":57,"label":{"label":"\\text{rename me}","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":22},{"from":23,"id":58,"label":{"label":"\\text{select me}","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":26},{"from":23,"id":59,"label":{"label":"","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":27},{"from":26,"id":60,"label":{"label":"","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":27},{"from":31,"id":61,"label":{"label":"","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":10},{"from":31,"id":62,"label":{"label":"","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":11},{"from":40,"id":63,"label":{"label":"","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":41},{"from":40,"id":64,"label":{"label":"","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":42},{"from":42,"id":65,"label":{"label":"","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":43},{"from":41,"id":66,"label":{"label":"","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":43},{"from":45,"id":67,"label":{"label":"f","style":{"alignment":"left","bend":-0.2,"dashed":true,"double":true,"head":"twoheads","position":0.7,"tail":"hook"}},"to":46},{"from":50,"id":68,"label":{"label":"f","style":{"alignment":"left","bend":0,"dashed":false,"double":false,"head":"default","position":0.5,"tail":"none"}},"to":51}],"nodes":[{"id":0,"label":{"label":"","pos":[360,354.1333312988281]}},{"id":1,"label":{"label":"\\textbf{Basic tutorial}","pos":[87,24.133331298828125]}},{"id":2,"label":{"label":"\\text{Select the point below, and press 'a' . Use the mouse or  'hjkl' to move the target point.}","pos":[577.75,217.63333129882812]}},{"id":3,"label":{"label":"\\text{\\underline{Arrow creation}}","pos":[77.75,217.63333129882812]}},{"id":4,"label":{"label":"\\text{\\underline{Commutative square}}","pos":[100,405.6333312988281]}},{"id":5,"label":{"label":"FS0","pos":[144.5,500.3208312988281]}},{"id":6,"label":{"label":"FSx","pos":[344.5,500.3208312988281]}},{"id":7,"label":{"label":"S(Fx+A)","pos":[344.5,700.3208312988281]}},{"id":8,"label":{"label":"\\text{Select the node $FSx$ below,  then press 's' and move around. Click to confirm.}","pos":[535,404.6333312988281]}},{"id":9,"label":{"label":"\\text{\\underline{Move \\& Merge}}","pos":[84,768.1333312988281]}},{"id":10,"label":{"label":"a","pos":[196,862.8208312988281]}},{"id":11,"label":{"label":"c","pos":[193,988.8208312988281]}},{"id":12,"label":{"label":"a'","pos":[488,862.8208312988281]}},{"id":13,"label":{"label":"b'","pos":[430,921.8208312988281]}},{"id":14,"label":{"label":"c'","pos":[485,988.8208312988281]}},{"id":15,"label":{"label":"\\text{Select the node $\\mathbf{b}$ below, press 'g' , use the mouse or  'hjkl' to move. Click to confirm.}","pos":[564,770.1333312988281]}},{"id":16,"label":{"label":"\\text{When moving $\\mathbf{b}$, hold 'ctrl' while  hovering $b'$ to merge (click to confirm).}","pos":[513,801.1333312988281]}},{"id":17,"label":{"label":"h:FS \\rightarrow{S(F-+A)}","pos":[546.5,590.3208312988281]}},{"id":18,"label":{"label":"\\text{Use \\textbf{escape} any time to cancel any pending action (such as label editing).}","pos":[525,26.133331298828125]}},{"id":19,"label":{"label":"","pos":[247,1135.1333312988281]}},{"id":20,"label":{"label":"\\text{Select the arrow below, press 'r' to edit the label (or double click on it), Tab to confirm.}","pos":[473,1065.13330078125]}},{"id":21,"label":{"label":"\\text{\\underline{Rename}}","pos":[67,1066.1333312988281]}},{"id":22,"label":{"label":"","pos":[447,1135.1333312988281]}},{"id":23,"label":{"label":"","pos":[189.5,1396.039566040039]}},{"id":24,"label":{"label":"\\text{Select the arrow below, press 'a', move around, then press '='.  Click to confirm.}","pos":[529,1219.13330078125]}},{"id":25,"label":{"label":"\\text{\\underline{Higher cells}}","pos":[69,1221.13330078125]}},{"id":26,"label":{"label":"","pos":[389.5,1396.039566040039]}},{"id":27,"label":{"label":"","pos":[289.5,1300.789566040039]}},{"id":28,"label":{"label":"\\text{Press 'p' and click somewhere to create and label a point.}","pos":[458,115.13333129882812]}},{"id":29,"label":{"label":"\\text{\\underline{Point creation}}","pos":[74.5,116.88333129882812]}},{"id":30,"label":{"label":"\\text{Click to confirm the location.}","pos":[338.25,246.63333129882812]}},{"id":31,"label":{"label":"\\mathbf{b}","pos":[305,919.1333312988281]}},{"id":32,"label":{"label":"\\text{All these commands (and more) are listed above the canvas}","pos":[285,2279.5333251953125]}},{"id":33,"label":{"label":"\\text{Tab or enter to confirm.}","pos":[320,149.13333129882812]}},{"id":34,"label":{"label":"\\text{Edit the point label, then press Tab to edit the arrow label and then confirm it.}","pos":[545.25,278.6333312988281]}},{"id":35,"label":{"label":"\\text{Proceed as for a standard arrow creation}","pos":[366,1247.13330078125]}},{"id":36,"label":{"label":"\\text{Enter to validate the guessed labels (otherwise, use tab).}","pos":[451,439.1333312988281]}},{"id":37,"label":{"label":"\\text{\\underline{Add xy space}}","pos":[85.5,1483.5332946777344]}},{"id":38,"label":{"label":"\\text{Move the cursor inside the square below}","pos":[353.5,1492.5333557128906]}},{"id":39,"label":{"label":"\\text{Presse 'e', and draw a rectangle}","pos":[317.5,1525.5333557128906]}},{"id":40,"label":{"label":"a","pos":[190.5,1588.5333557128906]}},{"id":41,"label":{"label":"b","pos":[390.5,1588.5333557128906]}},{"id":42,"label":{"label":"c","pos":[190.5,1788.5333557128906]}},{"id":43,"label":{"label":"d","pos":[390.5,1788.5333557128906]}},{"id":44,"label":{"label":"\\text{\\underline{Arrow style}}","pos":[104,1851.3333740234375]}},{"id":45,"label":{"label":"a","pos":[151,1975.2333984375]}},{"id":46,"label":{"label":"b","pos":[351,1975.2333984375]}},{"id":47,"label":{"label":"\\text{The following keys change selected arrow style: >(=-bBA][}","pos":[428,1853.2333984375]}},{"id":48,"label":{"label":"\\text{Try them after selecting the arrow below}","pos":[353,1884.2333984375]}},{"id":49,"label":{"label":"\\text{\\underline{Detach arrow head/tail}}","pos":[143,2049.5333251953125]}},{"id":50,"label":{"label":"a","pos":[235,2127.433349609375]}},{"id":51,"label":{"label":"b","pos":[435,2127.433349609375]}},{"id":52,"label":{"label":"\\text{Select the arrow and press c. Press c again to detach the tail.}","pos":[536,2051.433349609375]}}]};
            var tutorial_format_version = 2;                        
        </script>
    </head>

    <body>       
        <h1>Diagram editor</h1>
   
     
        <p>
            A vi-inspired diagram editor, with              
            (latex) labelled nodes and edges, tested with Firefox, written in <a href="https://elm-lang.org/">Elm</a> (see the code on 
        <a href="https://github.com/amblafont/graph-editor-web">github</a>).
            Higher cells are supported.
	    It is far less sophisticated than <a href="https://q.uiver.app">Quiver</a>, but one useful feature (if you don't know the final shape of your diagram) is that you can draw anywhere, not just on the grid (whose size can be later adjusted).
	    </p>
	    <p>
	    For a LaTeX export, first export to <a href="https://q.uiver.app">Quiver</a> (beware that vertices will be snapped
            to the grid in the process).
	    </p>
	    <p>
        </p>
        <button onclick="loadGraph()" >Load graph</button>
        <button title="Local or session storage" onclick="quickloadGraph()" >QuickLoad graph</button>
        
    <!--     <button onclick="dispatchRenderedChildren(document)">
            Recompute the layer
        </button> -->
        
        <!-- first use of katex element. It seems it should be done
        beforehand, otherwise dispatchRendered on the first labelled point  
        gets wrong dimensions.
        -->
        <math-latex> </math-latex>
        <div id="myapp"></div>
        <script>
         var appDiv = document.getElementById('myapp');

       
     
        
         
        function dispatchRendered(node) {            
            if (node.clientWidth != null)
                     {
                         // could be optimized by having an additionnal
                         // attribute that tells whether it has
                         // a listener
                         var rect = { width : node.clientWidth , height : node.clientHeight }
                         /* if (node.tagName = "MATH-LATEX") {
                            console.log (rect);
                            console.log (node.getBoundingClientRect());
                         } */
                         node.dispatchEvent(new CustomEvent(renderedEvent, { detail : rect } ));
                     }
        };

        function dispatchRenderedChildren(node) {
            children = node.getElementsByClassName(renderedClass);
                     for (var i = 0; i < children.length; ++i) {
                          dispatchRendered(children[i]);
                      }        
        }
        function fullDispatchRendered(node) {
            dispatchRendered(node);
            if (node.getElementsByClassName != null) {                                                  
                  dispatchRenderedChildren(node);  
            }
        }

         // rendered event handlers
         // Fonction callback à éxécuter quand une mutation est observée
         var callbackMutation = function(mutationsList) {
             for(var mutation of mutationsList) {
	               for(var node of mutation.addedNodes) {
             
                    fullDispatchRendered(node);
                 }
                
	            /*    for(var node of mutation.removedNodes) {
                     if (node.getBoundingClientRect != null)
                     {
                         node.dispatchEvent(new CustomEvent("remove"));
                     }
                 } */
             }
         };

         // Créé une instance de l'observateur lié à la fonction de callback
         var observer = new MutationObserver(callbackMutation);
         observer.observe(appDiv, 
	                        { subtree: true, childList: true }); 

         // initialisation de Elm

         var app = Elm.Main.init({
             node: appDiv
         });
         var tutoData = {"graph" : tutorial, "fileName" : "graph.json" };
         
         app.ports["loadedGraph" + tutorial_format_version].send(tutoData);

         function sendGraphToElm(json, filename) {
            var graph = json;
            var version = 0;
            if (json.hasOwnProperty('version')) {
               version = json.version;
               graph = json.graph;
            }
            
            var args = { graph : graph, fileName : filename};
            app.ports["loadedGraph" + version].send(args);
         }
        
         
         // load a json graph file, send it to the elm component
         function loadGraph() {
             var input = document.createElement('input');
             input.type = 'file';
             input.accept = ".json";
             input.onchange = e => {
                 var file = e.target.files[0];
                 var fr=new FileReader();
                 fr.onload=function(){
                     var json = JSON.parse (fr.result);
                     sendGraphToElm(json, file.name);
                 }
                 fr.readAsText(file);
             }

             input.click();
         };

        // load a json graph file, from local storage
        function quickloadGraph() {
             // Check browser support
             if (typeof(Storage) !== "undefined") {
               // we first try loading from the current
               // session storage, to avoid conflicts with
               // other possibly opened tabs
               var result = sessionStorage.getItem(storageKey);
               if (!result) 
                  result = localStorage.getItem(storageKey);
               if (result) {
                  var json = JSON.parse(result);
                  var fileName = json.fileName;                  
                  sendGraphToElm(json, json.fileName);    
               }
               else
                  alert('No quicksaved graph found');
             } 
             else
                 alert("Sorry, your browser does not support Web Storage.");
             
             
         };
         // this event handler computes the relative position
         // of the mouse with respect to the current target
         // (the one to which the event is attached)
         app.ports.onMouseMove.subscribe(function(e) {
             if ( e.currentTarget) {
                 var rect = e.currentTarget.getBoundingClientRect();
                 var x = e.clientX - rect.left; //x position within the element.
                 var y = e.clientY - rect.top;  //y position within the element.
                 app.ports.onMouseMoveFromJS.send([x, y]);
             }
         });

         app.ports.preventDefault.subscribe(function (e) {
             e.preventDefault();
         });
         // asks the user to download some file, generated from content
         function download(content, fileName, contentType) {
             var a = document.createElement("a");
             var file = new Blob([content], {type: contentType});
             a.href = URL.createObjectURL(file);
             a.download = fileName;
             a.click();
         }

         function fromElmGraph(a) {
             return {graph : a.graph, version : a.version };;
         }
         app.ports.saveGraph.subscribe(function(a) {
             var d = fromElmGraph(a);
             var name = window.prompt("Filename?", a.fileName) ;
             if (name) {
               download(JSON.stringify(d), name /* + '.json' */, 'application/json');
               app.ports.savedGraph.send(name);
             }
         });

         app.ports.quicksaveGraph.subscribe(function(arg) {
            console.log("Quicksaving...");
            var a = arg.info
            var d = fromElmGraph(a);
            d.fileName = a.fileName;
             // Check browser support
             if (typeof(Storage) !== "undefined") {               
               // Store even if the browser is closed
               localStorage.setItem(storageKey, JSON.stringify(d));
               // we put it also in a temporary session storage
               // in case multiple tabs are opened
               sessionStorage.setItem(storageKey, JSON.stringify(d));
               if (arg.feedback)
                   alert("Successful quicksave");               
               alert("Successful quicksave");               
                   alert("Successful quicksave");               
             } else {
                if (arg.feedback)
                    alert("Sorry, your browser does not support Web Storage.");
             }
             
         });

         app.ports.exportQuiver.subscribe(function(d) {
             // copied from quiver/quiver.js (export base64)
             var s = `https://q.uiver.app/?q=${
              btoa(unescape(encodeURIComponent(JSON.stringify(d))))}`;
              window.open(s);             
         });

         app.ports.clipboardWriteGraph.subscribe(function(g) {
            navigator.clipboard.writeText(JSON.stringify(g));                     
         });
        
         function handlePasteGraph(event) {   
            const paste = event.detail;
            var json;
            try { json = JSON.parse(paste); }
            catch (e) { json = false; }
            if (json) 
              app.ports.clipboardGraph.send(json);
         }

         app.ports.pasteGraph.subscribe(handlePasteGraph);

         app.ports.alert.subscribe(function(s) {
             alert(s);
         });

         app.ports.jumpToId.subscribe(function(s) {             
             var elmnt = document.getElementById(s);
             elmnt.scrollIntoView(); 
         });

         app.ports.computeLayout.subscribe(function(s) {                         
             var children = document.getElementsByClassName(renderedClass);             
             for (var i = 0; i < children.length; ++i) {
                          dispatchRendered(children[i]);
                      }   
         });

         app.ports.promptFindReplace.subscribe(function(a) {             
             var rep = window.prompt("Replace in selection (/find/replace, where '/' can be replaced by any character)", 
                  "/find/replace") ;
             if (rep && rep.length > 2) {
                reps = rep.split(rep[0])                
                if (reps && reps.length == 3 && reps[1])
                    findReplace(reps[1], reps[2])
             }             
             
         });

         function findReplace(search, replace) {
         app.ports.findReplace.send({'search':search, 'replace': replace});
         }

         // Elm browser keydown handler is passive
         // and thus cannot prevent default behaviour
         // so we make our custom event listener.
         document.addEventListener("keydown", function(event)  {
                    app.ports.onKeyDownActive.send(event);
         }
        );
        </script>
    </body>
</html>
